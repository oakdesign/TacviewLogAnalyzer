<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tacview Log Analyzer - Web UI</title>
    <style>
      body {
        font-family: system-ui, Arial, sans-serif;
        margin: 1rem;
      }
      .pilot {
        margin: 0.5rem 0;
      }
      summary {
        cursor: pointer;
        font-weight: 600;
      }
      .muted {
        color: #666;
      }
      .counts {
        font-size: 0.9rem;
        color: #444;
        margin-left: 0.5rem;
      }
      table {
        border-collapse: collapse;
        margin: 0.5rem 0;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 0.3rem 0.5rem;
      }
      th {
        background: #f6f6f6;
      }
      code {
        background: #f5f5f5;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
      }
      
      /* File picker styles */
      .file-picker {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 1rem;
        margin: 1rem 0;
      }
      .file-picker h3 {
        margin-top: 0;
        color: #333;
      }
      .btn {
        padding: 0.5rem 1rem;
        border: 1px solid #ccc;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        text-decoration: none;
        color: inherit;
      }
      .btn:hover {
        background: #f0f0f0;
      }
      .btn-primary {
        background: #007acc;
        color: white;
        border-color: #007acc;
      }
      .btn-primary:hover {
        background: #005a99;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <h1>Tacview Log Analyzer</h1>
    
    <!-- File Browser -->
    <div class="file-picker">
      <h3>üìÅ Select XML File</h3>
      
      <!-- File browser interface -->
      <div style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" onclick="showFileBrowser()">
          üìÇ Browse Files
        </button>
        <span id="selectedFileName" style="margin-left: 1rem; color: #666;"></span>
      </div>
      
      <!-- File browser popup -->
      <div id="fileBrowserPopup" style="display: none; border: 1px solid #ccc; background: white; padding: 1rem; margin-top: 0.5rem;">
        <div style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
          <strong>Select XML File</strong>
          <button onclick="hideFileBrowser()" style="float: right; border: none; background: none; font-size: 1.2em; cursor: pointer;">&times;</button>
        </div>
        <div id="currentPath" style="font-family: monospace; font-size: 0.9em; color: #666; margin-bottom: 0.5rem;"></div>
        <div id="fileList" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee;">
          <div class="loading">Loading files...</div>
        </div>
        <div style="margin-top: 0.5rem;">
          <button type="button" class="btn" onclick="navigateUp()">‚¨ÜÔ∏è Up</button>
          <button type="button" class="btn btn-primary" id="selectBtn" onclick="loadSelectedFile()" disabled>Load File</button>
        </div>
      </div>
      
      <!-- Advanced: Direct path input -->
      <details>
        <summary style="cursor: pointer; color: #666; font-size: 0.9em;">Advanced: Enter path manually</summary>
        <form method="get" style="margin-top: 0.5rem;">
          <label>File path:
            <input type="text" name="xml" id="pathInput" value="{{ xml or '' }}" size="60" placeholder="Enter full path to XML file..."/>
            <button type="submit" class="btn btn-primary">Load</button>
          </label>
        </form>
      </details>
    </div>

    {% if error %}
    <p style="color: #b00">{{ error }}</p>
    {% endif %} {% if hasData %}
    <p class="muted">Loaded: <code>{{ xml }}</code></p>

    {% if vm.overview %}
    <h2>Overall</h2>
    <table>
      <thead>
        <tr>
          <th>Human Pilots</th>
          <th>Landed</th>
          <th>Ejected / Shot down</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ vm.overview.humanPilots }}</td>
          <td>{{ vm.overview.landedPilots }}</td>
          <td>{{ vm.overview.ejectedOrShotPilots }}</td>
        </tr>
      </tbody>
    </table>

    {% if vm.overview.shotsByWeapon %}
    <h3>Shots / Hits / Kills by Weapon</h3>
    <table>
      <thead>
        <tr>
          <th>Weapon</th>
          <th>Shots</th>
          <th>Hits</th>
          <th>Kills</th>
        </tr>
      </thead>
      <tbody>
        {% for row in vm.overview.shotsByWeapon %}
        <tr>
          <td>{{ row.weapon }}</td>
          <td>{{ row.shots }}</td>
          <td>{{ row.hits }}</td>
          <td>{{ row.kills }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %} {% endif %}

    <div
      id="pilot-sorting"
      style="margin: 0.5rem 0; display: none; gap: 0.5rem; flex-wrap: wrap"
    >
      <strong>Sort pilots:</strong>
      <button
        type="button"
        data-sort="shots"
        title="Sort by total shots (desc)"
      >
        Shots ‚Üì
      </button>
      <button
        type="button"
        data-sort="kills"
        title="Sort by total kills (desc)"
      >
        Kills ‚Üì
      </button>
      <button type="button" data-sort="aakills" title="Sort by AA kills (desc)">
        AA-Kills ‚Üì
      </button>
      <button type="button" data-sort="agkills" title="Sort by AG kills (desc)">
        A-G Kills ‚Üì
      </button>
      <button
        type="button"
        data-sort="name"
        title="Sort alphabetically by pilot name"
      >
        Name A‚ÜíZ
      </button>
      <button
        type="button"
        data-sort="default"
        title="Original order (shots desc)"
      >
        Default
      </button>
    </div>

    <div id="pilots-container">
      {% for p in vm.pilots %}
      <details
        class="pilot"
        data-pilot-name="{{ p.pilot or '' }}"
        data-pilot-shots="{{ p.totals.shots }}"
        data-pilot-kills="{{ p.totals.kills }}"
        data-pilot-aakills="{{ p.totalsAA.kills }}"
        data-pilot-agkills="{{ p.totalsAG.kills }}"
        data-default-index="{{ loop.index0 }}"
      >
        <summary>
          {{ p.pilot or 'Unknown' }}
          <span class="counts"
            >Shots {{ p.totals.shots }}{% if p.totalsFriendly and
            p.totalsFriendly.shots %} / {{ p.totalsFriendly.shots }} FF{% endif
            %} ¬∑ Hits {{ p.totals.hits }}{% if p.totalsFriendly and
            p.totalsFriendly.hits %} / {{ p.totalsFriendly.hits }} FF{% endif %}
            ¬∑ Kills {{ p.totals.kills }}{% if p.totalsFriendly and
            p.totalsFriendly.kills %} / {{ p.totalsFriendly.kills }} FF{% endif
            %} ¬∑ Misses {{ p.totals.misses }} ¬∑ Flight {{ p.flightTime }}{% if
            p.flightEnd %} ¬∑ End {{ p.flightEnd }}{% endif %}
            <br />
            <span class="muted"
              >A-A S/H/K: {{ p.totalsAA.shots }}/{{ p.totalsAA.hits }}/{{
              p.totalsAA.kills }} ¬∑ A-G S/H/K: {{ p.totalsAG.shots }}/{{
              p.totalsAG.hits }}/{{ p.totalsAG.kills }}</span
            >
          </span>
        </summary>

        <details open style="margin-left: 1rem">
          <summary>Weapon summary ({{ p.byWeapon | length }})</summary>
          <table>
            <thead>
              <tr>
                <th>Weapon</th>
                <th>Shots</th>
                <th>Hits</th>
                <th>Kills</th>
                <th>Misses</th>
              </tr>
            </thead>
            <tbody>
              {% for w in p.byWeapon %}
              <tr>
                <td>{{ w.weapon }}</td>
                <td>{{ w.shots }}</td>
                <td>{{ w.hits }}</td>
                <td>{{ w.kills }}</td>
                <td>{{ w.misses }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>

        <details style="margin-left: 1rem">
          <summary>
            Events ({{ (p.chains | length) + (p.misses | length) }})
          </summary>
          <table>
            <thead>
              <tr>
                <th>ShotT</th>
                <th>Weapon</th>
                <!--<th>WeaponID</th>-->
                <th>Target</th>
                <th>HitT</th>
                <th>KillT</th>
                <th>Extra Kills</th>
                <th>Flags</th>
                <th>Domain</th>
              </tr>
            </thead>
            <tbody>
              {% for c in p.chains %}
              <tr>
                <td title="{{ '%.2f'|format(c.shotT) }}">
                  {{ c.shotStr or ('%.2f'|format(c.shotT)) }}
                </td>
                <td>{{ c.weapon }}</td>
                <!--<td>{{ c.weaponId }}</td>-->
                <td>{{ c.targetName or '' }}</td>
                <td title="{{ c.hitT and '%.2f'|format(c.hitT) or '' }}">
                  {{ c.hitStr }}
                </td>
                <td title="{{ c.killT and '%.2f'|format(c.killT) or '' }}">
                  {{ c.killStr }}
                </td>
                <td>
                  {% if c.extraKillNames and c.extraKillNames|length > 0 %}{{
                  c.extraKillNames|join(', ') }}{% endif %}
                </td>
                <td>
                  <!--{{ c.method }}-->{% if c.intercepted %}Intercepted by {{
                  c.interceptorName }}{% endif %}{% if c.shooterMismatch %}{% if
                  c.intercepted %}, {% endif %}ShooterMismatch{% endif %}{% if
                  c.friendly %}{% if c.intercepted or c.shooterMismatch %}, {%
                  endif %}Friendly{% endif %}
                </td>
                <td>{{ c.domain }}</td>
              </tr>
              {% endfor %} {% for m in p.misses %}
              <tr>
                <td title="{{ '%.2f'|format(m.shotT) }}">
                  {{ m.shotStr or ('%.2f'|format(m.shotT)) }}
                </td>
                <td>{{ m.weapon }}</td>
                <!--<td>{{ m.weaponId }}</td>-->
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  {% if m.intercepted %}Intercepted by {{ m.interceptorName }}{%
                  else %}Miss{% endif %}
                </td>
                <td>{{ m.domain }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>

        <!--<details>
        <summary>Misses ({{ p.misses | length }}) <span class="muted">(excludes Shell & Parachutist)</span></summary>
        <table>
          <thead>
            <tr><th>ShotT</th><th>Weapon</th><th>WeaponID</th></tr>
          </thead>
          <tbody>
          {% for m in p.misses %}
            <tr>
              <td>{{ '%.2f'|format(m.shotT) }}</td>
              <td>{{ m.weapon }}</td>
              <td>{{ m.weaponId }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </details>-->
      </details>
      {% endfor %}
    </div>
    {% endif %}
    <script>
      (function () {
        const container = document.getElementById("pilots-container");
        const bar = document.getElementById("pilot-sorting");
        if (!container || !bar) return;
        const pilots = Array.from(container.querySelectorAll("details.pilot"));
        if (pilots.length === 0) return;
        bar.style.display = "flex";
        const original = pilots.slice();
        function applySort(kind) {
          let sorted = pilots.slice();
          // helper to safely parse numeric dataset values (defaults to 0)
          const getNum = (el, key) => {
            const v = el.dataset[key];
            const n = Number(v);
            return Number.isFinite(n) ? n : 0;
          };
          if (kind === "shots") {
            sorted.sort(
              (a, b) =>
                Number(b.dataset.pilotShots) - Number(a.dataset.pilotShots) ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "kills") {
            sorted.sort(
              (a, b) =>
                Number(b.dataset.pilotKills) - Number(a.dataset.pilotKills) ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "aakills") {
            sorted.sort(
              (a, b) =>
                getNum(b, "pilotAakills") - getNum(a, "pilotAakills") ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "agkills") {
            sorted.sort(
              (a, b) =>
                getNum(b, "pilotAgkills") - getNum(a, "pilotAgkills") ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "name") {
            sorted.sort((a, b) =>
              a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "default") {
            sorted = original.slice();
          }
          // detach then append in order
          const frag = document.createDocumentFragment();
          sorted.forEach((el) => frag.appendChild(el));
          container.innerHTML = "";
          container.appendChild(frag);
        }
        bar.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-sort]");
          if (!btn) return;
          applySort(btn.dataset.sort);
        });
      })();
      
      // Simple file browser functionality
      let currentPath = '';
      let selectedFile = '';
      
      function showFileBrowser() {
        document.getElementById('fileBrowserPopup').style.display = 'block';
        loadDirectory('');
      }
      
      function hideFileBrowser() {
        document.getElementById('fileBrowserPopup').style.display = 'none';
      }
      
      function loadDirectory(path) {
        currentPath = path;
        const fileList = document.getElementById('fileList');
        const pathDiv = document.getElementById('currentPath');
        
        fileList.innerHTML = '<div style="padding: 0.5rem;">Loading...</div>';
        
        const url = path ? `/ui/api/browse?path=${encodeURIComponent(path)}` : '/ui/api/browse';
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            pathDiv.textContent = data.current_path;
            fileList.innerHTML = '';
            
            // Add directories
            data.directories.forEach(dir => {
              const item = document.createElement('div');
              item.style.cssText = 'padding: 0.3rem; cursor: pointer; border-bottom: 1px solid #f0f0f0;';
              item.innerHTML = `üìÅ ${dir.name}`;
              item.onclick = () => loadDirectory(dir.path);
              item.onmouseover = () => item.style.background = '#f0f8ff';
              item.onmouseout = () => item.style.background = '';
              fileList.appendChild(item);
            });
            
            // Add XML files
            data.files.forEach(file => {
              const item = document.createElement('div');
              item.style.cssText = 'padding: 0.3rem; cursor: pointer; border-bottom: 1px solid #f0f0f0;';
              item.innerHTML = `üìÑ ${file.name}`;
              item.onclick = () => selectFile(file.path, file.name);
              item.onmouseover = () => item.style.background = '#f0f8ff';
              item.onmouseout = () => item.style.background = selectedFile === file.path ? '#e6f3ff' : '';
              if (selectedFile === file.path) item.style.background = '#e6f3ff';
              fileList.appendChild(item);
            });
            
            if (data.directories.length === 0 && data.files.length === 0) {
              fileList.innerHTML = '<div style="padding: 0.5rem; color: #666;">No XML files found</div>';
            }
          })
          .catch(err => {
            fileList.innerHTML = `<div style="padding: 0.5rem; color: #b00;">Error: ${err.message}</div>`;
          });
      }
      
      function selectFile(filePath, fileName) {
        selectedFile = filePath;
        document.getElementById('selectedFileName').textContent = `Selected: ${fileName}`;
        document.getElementById('selectBtn').disabled = false;
        document.getElementById('selectBtn').textContent = `Load "${fileName}"`;
        
        // Refresh the file list to show selection
        const fileList = document.getElementById('fileList');
        Array.from(fileList.children).forEach(item => {
          item.style.background = item.textContent.includes(fileName) ? '#e6f3ff' : '';
        });
      }
      
      function loadSelectedFile() {
        if (selectedFile) {
          document.getElementById('pathInput').value = selectedFile;
          document.querySelector('form').submit();
        }
      }
      
      function navigateUp() {
        fetch(`/ui/api/browse?path=${encodeURIComponent(currentPath)}`)
          .then(response => response.json())
          .then(data => {
            if (data.parent_path) {
              loadDirectory(data.parent_path);
            }
          });
      }
    </script>
  </body>
</html>
