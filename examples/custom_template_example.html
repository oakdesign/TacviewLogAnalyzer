<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tacview Log Analyzer - Custom Template Example</title>
    <style>
      /* 
      ==========================================
      CUSTOM TEMPLATE EXAMPLE - ENHANCED
      ==========================================
      
      This is an example custom template for Tacview Log Analyzer with enhanced file picker.
      To use this template:
      1. Copy this file to the same directory as TacviewLogAnalyzer.exe
      2. Rename it to "index.html"
      3. Customize the styling and layout as desired
      4. Run TacviewLogAnalyzer.exe (will auto-start web interface)
      
      FEATURES INCLUDED:
      - ğŸ“‚ File browser with directory navigation
      - ğŸ¨ Custom dark terminal-style theme
      - âš¡ Animated UI elements and glow effects
      - ğŸ“± Responsive design for mobile/desktop
      
      The template uses Jinja2 syntax for data binding.
      All data variables (vm.pilots, vm.overview, etc.) remain the same.
      Only the HTML structure and CSS styling can be customized.
      ==========================================
      */
      
      /* Dark theme with terminal-style aesthetics */
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #00ff41;
        font-family: 'Courier New', monospace;
        margin: 0;
        padding: 1rem;
        min-height: 100vh;
      }
      
      /* Custom notice banner */
      .custom-notice {
        background: linear-gradient(45deg, #ff6b35, #f7931e);
        color: #000;
        padding: 0.8rem;
        text-align: center;
        font-weight: bold;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      }
      
      h1 {
        color: #00ffff;
        text-shadow: 0 0 10px #00ffff;
        text-align: center;
        font-size: 2.5rem;
        margin-bottom: 1rem;
      }
      
      h2, h3 {
        color: #00ffff;
        text-shadow: 0 0 5px #00ffff;
      }
      
      /* Form styling */
      form {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
      }
      
      input[type="text"] {
        background: #1a1a1a;
        color: #00ff41;
        border: 2px solid #00ff41;
        padding: 0.5rem;
        border-radius: 4px;
        font-family: inherit;
      }
      
      button {
        background: linear-gradient(45deg, #00ff41, #00cc33);
        color: #000;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 255, 65, 0.3);
      }
      
      /* Pilot section styling */
      .pilot {
        background: rgba(0, 0, 0, 0.4);
        margin: 0.8rem 0;
        border-radius: 8px;
        border-left: 4px solid #00ff41;
      }
      
      summary {
        cursor: pointer;
        font-weight: 600;
        padding: 0.8rem;
        transition: background 0.3s ease;
      }
      
      summary:hover {
        background: rgba(0, 255, 65, 0.1);
      }
      
      .counts {
        font-size: 0.9rem;
        color: #ffff00;
        margin-left: 0.5rem;
      }
      
      .muted {
        color: #888;
      }
      
      /* Table styling */
      table {
        border-collapse: collapse;
        margin: 0.5rem 0;
        width: 100%;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 8px;
        overflow: hidden;
      }
      
      th, td {
        border: 1px solid #333;
        padding: 0.5rem;
        text-align: left;
      }
      
      th {
        background: linear-gradient(45deg, #333, #555);
        color: #00ffff;
        font-weight: bold;
      }
      
      tr:nth-child(even) {
        background: rgba(255, 255, 255, 0.05);
      }
      
      tr:hover {
        background: rgba(0, 255, 65, 0.1);
      }
      
      /* Code styling */
      code {
        background: #1a1a1a;
        color: #00ff41;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        border: 1px solid #333;
      }
      
      /* Error styling */
      .error {
        color: #ff4444;
        background: rgba(255, 68, 68, 0.1);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #ff4444;
      }
      
      /* Sorting controls */
      #pilot-sorting {
        background: rgba(0, 0, 0, 0.3);
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }
      
      #pilot-sorting button {
        margin: 0.2rem;
        font-size: 0.9rem;
      }
      
      /* Responsive design */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem;
        }
        
        h1 {
          font-size: 2rem;
        }
        
        table {
          font-size: 0.8rem;
        }
        
        input[type="text"] {
          width: 100%;
          box-sizing: border-box;
        }
      }
      
      /* Animation for loading */
      @keyframes glow {
        0%, 100% { text-shadow: 0 0 5px #00ffff; }
        50% { text-shadow: 0 0 20px #00ffff, 0 0 30px #00ffff; }
      }
      
      .glow-animation {
        animation: glow 2s ease-in-out infinite;
      }
      
      /* File picker styles (custom themed) */
      .file-picker {
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid #00ff41;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
      }
      .file-picker h3 {
        margin-top: 0;
        color: #00ffff;
        text-shadow: 0 0 10px #00ffff;
      }
      .btn {
        padding: 0.8rem 1.5rem;
        border: 2px solid #00ff41;
        background: rgba(0, 255, 65, 0.1);
        border-radius: 5px;
        cursor: pointer;
        color: #00ff41;
        font-family: 'Courier New', monospace;
        font-weight: bold;
        text-decoration: none;
        transition: all 0.3s ease;
      }
      .btn:hover {
        background: rgba(0, 255, 65, 0.2);
        box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
        transform: translateY(-2px);
      }
      .btn-primary {
        background: rgba(0, 255, 255, 0.1);
        border-color: #00ffff;
        color: #00ffff;
      }
      .btn-primary:hover {
        background: rgba(0, 255, 255, 0.2);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
      }
      #fileBrowserPopup {
        border: 2px solid #ff6b35;
        background: rgba(0, 0, 0, 0.95);
        border-radius: 8px;
        box-shadow: 0 0 25px rgba(255, 107, 53, 0.4);
      }
      #fileList > div {
        transition: all 0.2s ease;
      }
      #fileList > div:hover {
        background: rgba(0, 255, 65, 0.1) !important;
        transform: translateX(5px);
      }
    </style>
  </head>
  <body>
    <!-- Custom notice to show template is active -->
    <div class="custom-notice">
      ğŸš€ CUSTOM TEMPLATE ACTIVE! ğŸš€<br>
      This is an example of how you can customize the Tacview Log Analyzer interface.
    </div>
    
    <h1 class="glow-animation">ğŸ¯ Tacview Log Analyzer</h1>
    
    <!-- Enhanced File Browser -->
    <div class="file-picker">
      <h3>ğŸ“ Select XML File</h3>
      
      <!-- File browser interface -->
      <div style="margin-bottom: 1rem;">
        <button type="button" class="btn btn-primary" onclick="showFileBrowser()">
          ğŸ“‚ Browse Files
        </button>
        <span id="selectedFileName" style="margin-left: 1rem; color: #00ff41;"></span>
      </div>
      
      <!-- File browser popup -->
      <div id="fileBrowserPopup" style="display: none; border: 1px solid #ccc; background: white; padding: 1rem; margin-top: 0.5rem;">
        <div style="border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 0.5rem;">
          <strong style="color: #00ffff;">Select XML File</strong>
          <button onclick="hideFileBrowser()" style="float: right; border: none; background: none; font-size: 1.2em; cursor: pointer; color: #ff6b35;">&times;</button>
        </div>
        <div id="currentPath" style="font-family: monospace; font-size: 0.9em; color: #00ff41; margin-bottom: 0.5rem;"></div>
        <div id="fileList" style="max-height: 200px; overflow-y: auto; border: 1px solid #00ff41;">
          <div class="loading">Loading files...</div>
        </div>
        <div style="margin-top: 0.5rem;">
          <button type="button" class="btn" onclick="navigateUp()">â¬†ï¸ Up</button>
          <button type="button" class="btn btn-primary" id="selectBtn" onclick="loadSelectedFile()" disabled>Load File</button>
        </div>
      </div>
      
      <!-- Advanced: Direct path input -->
      <details>
        <summary style="cursor: pointer; color: #00ff41; font-size: 0.9em;">Advanced: Enter path manually</summary>
        <form method="get" style="margin-top: 0.5rem;">
          <label style="color: #00ffff;">
            ğŸ“ XML file path:
            <input type="text" name="xml" id="pathInput" value="{{ xml or '' }}" size="80" placeholder="Enter path to your Tacview XML file..." style="background: rgba(0,0,0,0.8); color: #00ff41; border: 1px solid #00ff41; padding: 0.5rem; border-radius: 3px;"/>
            <button type="submit" class="btn btn-primary">ğŸ” Load & Analyze</button>
          </label>
        </form>
      </details>
    </div>

    {% if error %}
    <div class="error">âŒ {{ error }}</div>
    {% endif %}
    
    {% if hasData %}
    <p class="muted">âœ… Loaded: <code>{{ xml }}</code></p>

    {% if vm.overview %}
    <h2>ğŸ“Š Mission Overview</h2>
    <table>
      <thead>
        <tr>
          <th>ğŸ‘¨â€âœˆï¸ Human Pilots</th>
          <th>ğŸ›¬ Landed</th>
          <th>ğŸ’¥ Ejected / Shot down</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ vm.overview.humanPilots }}</td>
          <td>{{ vm.overview.landedPilots }}</td>
          <td>{{ vm.overview.ejectedOrShotPilots }}</td>
        </tr>
      </tbody>
    </table>

    {% if vm.overview.shotsByWeapon %}
    <h3>ğŸš€ Shots / Hits / Kills by Weapon</h3>
    <table>
      <thead>
        <tr>
          <th>ğŸ”« Weapon</th>
          <th>ğŸ¯ Shots</th>
          <th>ğŸ’¥ Hits</th>
          <th>â˜ ï¸ Kills</th>
        </tr>
      </thead>
      <tbody>
        {% for row in vm.overview.shotsByWeapon %}
        <tr>
          <td>{{ row.weapon }}</td>
          <td>{{ row.shots }}</td>
          <td>{{ row.hits }}</td>
          <td>{{ row.kills }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% endif %}
    {% endif %}

    <!-- Pilot sorting controls -->
    <div id="pilot-sorting" style="display: none; gap: 0.5rem; flex-wrap: wrap">
      <strong>ğŸ”„ Sort pilots:</strong>
      <button type="button" data-sort="shots" title="Sort by total shots (desc)">ğŸ¯ Shots â†“</button>
      <button type="button" data-sort="kills" title="Sort by total kills (desc)">â˜ ï¸ Kills â†“</button>
      <button type="button" data-sort="aakills" title="Sort by AA kills (desc)">âœˆï¸ AA-Kills â†“</button>
      <button type="button" data-sort="agkills" title="Sort by AG kills (desc)">ğŸ—ï¸ A-G Kills â†“</button>
      <button type="button" data-sort="name" title="Sort alphabetically by pilot name">ğŸ“ Name Aâ†’Z</button>
      <button type="button" data-sort="default" title="Original order (shots desc)">ğŸ”„ Default</button>
    </div>

    <!-- Pilot details -->
    <div id="pilots-container">
      {% for p in vm.pilots %}
      <details
        class="pilot"
        data-pilot-name="{{ p.pilot or '' }}"
        data-pilot-shots="{{ p.totals.shots }}"
        data-pilot-kills="{{ p.totals.kills }}"
        data-pilot-aakills="{{ p.totalsAA.kills }}"
        data-pilot-agkills="{{ p.totalsAG.kills }}"
        data-default-index="{{ loop.index0 }}"
      >
        <summary>
          ğŸ‘¨â€âœˆï¸ {{ p.pilot or 'Unknown' }}
          <span class="counts">
            ğŸ¯ Shots {{ p.totals.shots }}{% if p.totalsFriendly and p.totalsFriendly.shots %} / {{ p.totalsFriendly.shots }} FF{% endif %}
            Â· ğŸ’¥ Hits {{ p.totals.hits }}{% if p.totalsFriendly and p.totalsFriendly.hits %} / {{ p.totalsFriendly.hits }} FF{% endif %}
            Â· â˜ ï¸ Kills {{ p.totals.kills }}{% if p.totalsFriendly and p.totalsFriendly.kills %} / {{ p.totalsFriendly.kills }} FF{% endif %}
            Â· âŒ Misses {{ p.totals.misses }}
            Â· â±ï¸ Flight {{ p.flightTime }}{% if p.flightEnd %} Â· ğŸ End {{ p.flightEnd }}{% endif %}
            <br />
            <span class="muted">
              âœˆï¸ A-A S/H/K: {{ p.totalsAA.shots }}/{{ p.totalsAA.hits }}/{{ p.totalsAA.kills }}
              Â· ğŸ—ï¸ A-G S/H/K: {{ p.totalsAG.shots }}/{{ p.totalsAG.hits }}/{{ p.totalsAG.kills }}
            </span>
          </span>
        </summary>

        <details open style="margin-left: 1rem">
          <summary>ğŸ”« Weapon summary ({{ p.byWeapon | length }})</summary>
          <table>
            <thead>
              <tr>
                <th>ğŸš€ Weapon</th>
                <th>ğŸ¯ Shots</th>
                <th>ğŸ’¥ Hits</th>
                <th>â˜ ï¸ Kills</th>
                <th>âŒ Misses</th>
              </tr>
            </thead>
            <tbody>
              {% for w in p.byWeapon %}
              <tr>
                <td>{{ w.weapon }}</td>
                <td>{{ w.shots }}</td>
                <td>{{ w.hits }}</td>
                <td>{{ w.kills }}</td>
                <td>{{ w.misses }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>

        <details style="margin-left: 1rem">
          <summary>ğŸ“‹ Events ({{ (p.chains | length) + (p.misses | length) }})</summary>
          <table>
            <thead>
              <tr>
                <th>â° ShotT</th>
                <th>ğŸ”« Weapon</th>
                <th>ğŸ¯ Target</th>
                <th>ğŸ’¥ HitT</th>
                <th>â˜ ï¸ KillT</th>
                <th>ğŸ’€ Extra Kills</th>
                <th>ğŸ·ï¸ Flags</th>
                <th>ğŸ Domain</th>
              </tr>
            </thead>
            <tbody>
              {% for c in p.chains %}
              <tr>
                <td title="{{ '%.2f'|format(c.shotT) }}">
                  {{ c.shotStr or ('%.2f'|format(c.shotT)) }}
                </td>
                <td>{{ c.weapon }}</td>
                <td>{{ c.targetName or '' }}</td>
                <td title="{{ c.hitT and '%.2f'|format(c.hitT) or '' }}">
                  {{ c.hitStr }}
                </td>
                <td title="{{ c.killT and '%.2f'|format(c.killT) or '' }}">
                  {{ c.killStr }}
                </td>
                <td>
                  {% if c.extraKillNames and c.extraKillNames|length > 0 %}
                  {{ c.extraKillNames|join(', ') }}
                  {% endif %}
                </td>
                <td>
                  {% if c.intercepted %}ğŸ›¡ï¸ Intercepted by {{ c.interceptorName }}{% endif %}
                  {% if c.shooterMismatch %}{% if c.intercepted %}, {% endif %}âš ï¸ ShooterMismatch{% endif %}
                  {% if c.friendly %}{% if c.intercepted or c.shooterMismatch %}, {% endif %}ğŸ¤ Friendly{% endif %}
                </td>
                <td>{{ c.domain }}</td>
              </tr>
              {% endfor %}
              {% for m in p.misses %}
              <tr>
                <td title="{{ '%.2f'|format(m.shotT) }}">
                  {{ m.shotStr or ('%.2f'|format(m.shotT)) }}
                </td>
                <td>{{ m.weapon }}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>
                  {% if m.intercepted %}ğŸ›¡ï¸ Intercepted by {{ m.interceptorName }}
                  {% else %}âŒ Miss{% endif %}
                </td>
                <td>{{ m.domain }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </details>
      </details>
      {% endfor %}
    </div>
    {% endif %}

    <!-- JavaScript for sorting functionality (unchanged from original) -->
    <script>
      (function () {
        const container = document.getElementById("pilots-container");
        const bar = document.getElementById("pilot-sorting");
        if (!container || !bar) return;
        const pilots = Array.from(container.querySelectorAll("details.pilot"));
        if (pilots.length === 0) return;
        bar.style.display = "flex";
        const original = pilots.slice();
        
        function applySort(kind) {
          let sorted = pilots.slice();
          // helper to safely parse numeric dataset values (defaults to 0)
          const getNum = (el, key) => {
            const v = el.dataset[key];
            const n = Number(v);
            return Number.isFinite(n) ? n : 0;
          };
          
          if (kind === "shots") {
            sorted.sort(
              (a, b) =>
                Number(b.dataset.pilotShots) - Number(a.dataset.pilotShots) ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "kills") {
            sorted.sort(
              (a, b) =>
                Number(b.dataset.pilotKills) - Number(a.dataset.pilotKills) ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "aakills") {
            sorted.sort(
              (a, b) =>
                getNum(b, "pilotAakills") - getNum(a, "pilotAakills") ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "agkills") {
            sorted.sort(
              (a, b) =>
                getNum(b, "pilotAgkills") - getNum(a, "pilotAgkills") ||
                a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "name") {
            sorted.sort((a, b) =>
              a.dataset.pilotName.localeCompare(b.dataset.pilotName)
            );
          } else if (kind === "default") {
            sorted = original.slice();
          }
          
          // detach then append in order
          const frag = document.createDocumentFragment();
          sorted.forEach((el) => frag.appendChild(el));
          container.innerHTML = "";
          container.appendChild(frag);
        }
        
        bar.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-sort]");
          if (!btn) return;
          applySort(btn.dataset.sort);
        });
      })();
      
      // File browser functionality (custom themed)
      let currentPath = '';
      let selectedFile = '';
      
      function showFileBrowser() {
        document.getElementById('fileBrowserPopup').style.display = 'block';
        loadDirectory('');
      }
      
      function hideFileBrowser() {
        document.getElementById('fileBrowserPopup').style.display = 'none';
      }
      
      function loadDirectory(path) {
        currentPath = path;
        const fileList = document.getElementById('fileList');
        const pathDiv = document.getElementById('currentPath');
        
        fileList.innerHTML = '<div style="padding: 0.5rem; color: #00ff41;">Loading...</div>';
        
        const url = path ? `/ui/api/browse?path=${encodeURIComponent(path)}` : '/ui/api/browse';
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            pathDiv.textContent = data.current_path;
            fileList.innerHTML = '';
            
            // Add directories
            data.directories.forEach(dir => {
              const item = document.createElement('div');
              item.style.cssText = 'padding: 0.3rem; cursor: pointer; border-bottom: 1px solid rgba(0,255,65,0.3); color: #00ffff;';
              item.innerHTML = `ğŸ“ ${dir.name}`;
              item.onclick = () => loadDirectory(dir.path);
              fileList.appendChild(item);
            });
            
            // Add XML files
            data.files.forEach(file => {
              const item = document.createElement('div');
              item.style.cssText = 'padding: 0.3rem; cursor: pointer; border-bottom: 1px solid rgba(0,255,65,0.3); color: #00ff41;';
              item.innerHTML = `ğŸ“„ ${file.name}`;
              item.onclick = () => selectFile(file.path, file.name);
              if (selectedFile === file.path) item.style.background = 'rgba(0,255,65,0.2)';
              fileList.appendChild(item);
            });
            
            if (data.directories.length === 0 && data.files.length === 0) {
              fileList.innerHTML = '<div style="padding: 0.5rem; color: #ff6b35;">No XML files found</div>';
            }
          })
          .catch(err => {
            fileList.innerHTML = `<div style="padding: 0.5rem; color: #ff6b35;">Error: ${err.message}</div>`;
          });
      }
      
      function selectFile(filePath, fileName) {
        selectedFile = filePath;
        document.getElementById('selectedFileName').textContent = `Selected: ${fileName}`;
        document.getElementById('selectBtn').disabled = false;
        document.getElementById('selectBtn').textContent = `Load "${fileName}"`;
        
        // Refresh the file list to show selection
        const fileList = document.getElementById('fileList');
        Array.from(fileList.children).forEach(item => {
          if (item.textContent.includes(fileName)) {
            item.style.background = 'rgba(0,255,65,0.2)';
          } else {
            item.style.background = '';
          }
        });
      }
      
      function loadSelectedFile() {
        if (selectedFile) {
          document.getElementById('pathInput').value = selectedFile;
          document.querySelector('form').submit();
        }
      }
      
      function navigateUp() {
        fetch(`/ui/api/browse?path=${encodeURIComponent(currentPath)}`)
          .then(response => response.json())
          .then(data => {
            if (data.parent_path) {
              loadDirectory(data.parent_path);
            }
          });
      }
    </script>
  </body>
</html>